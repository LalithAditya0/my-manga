<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viewer - Shattered Horizons</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <h1 id="chapter-title">Loading...</h1>
  <div id="page-container"></div>

  <!-- Nav at the bottom -->
  <nav class="nav-bar bottom-nav">
    <a href="../index.html" class="nav-btn">ğŸ  Home</a>
    <a href="index.html" class="nav-btn">ğŸ“– Chapters</a>
    <a id="prev-btn" class="nav-btn">â¬… Prev</a>
    <a id="next-btn" class="nav-btn">Next â¡</a>
    <button id="mode-toggle"></button>
  </nav>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let chapter = parseInt(urlParams.get('chapter') || "1", 10);
    let page = parseInt(urlParams.get('page') || "1", 10);

    const pageContainer = document.getElementById("page-container");
    const title = document.getElementById("chapter-title");

    function loadPage(ch, pg) {
      pageContainer.innerHTML = ""; // clear old page
      title.textContent = `Chapter ${ch} - Page ${pg}`;

      const img = new Image();
      img.src = `manga/chapter${ch}/page${pg}.png`;
      img.alt = `Page ${pg}`;
      img.onload = () => pageContainer.appendChild(img);
      img.onerror = () => {
        // If page not found, assume last page reached
        if (pg > 1) {
          page = pg - 1; // last valid page
        } else {
          pageContainer.textContent = "No pages found.";
        }
      };
    }

    // Buttons
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");

    function updateNav() {
      prevBtn.onclick = () => {
        if (page > 1) {
          page--;
          loadPage(chapter, page);
        } else if (chapter > 1) {
          // go to last page of previous chapter
          chapter--;
          findLastPage(chapter, (lastPage) => {
            page = lastPage;
            loadPage(chapter, page);
          });
        }
      };

      nextBtn.onclick = () => {
        const testImg = new Image();
        testImg.src = `manga/chapter${chapter}/page${page + 1}.png`;
        testImg.onload = () => {
          page++;
          loadPage(chapter, page);
        };
        testImg.onerror = () => {
          // no next page, move to next chapter
          chapter++;
          page = 1;
          loadPage(chapter, page);
        };
      };
    }

    // Find the last page of a chapter by checking until fail
    function findLastPage(ch, callback) {
      let testPage = 1;
      function check() {
        const img = new Image();
        img.src = `manga/chapter${ch}/page${testPage}.png`;
        img.onload = () => {
          testPage++;
          check();
        };
        img.onerror = () => {
          callback(testPage - 1);
        };
      }
      check();
    }

    // Initialize
    loadPage(chapter, page);
    updateNav();
  </script>

  <script src="../theme.js"></script>
</body>
</html>
